# Docker E2E Testing Environment

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€Docker Composeã‚’ä½¿ç”¨ã—ãŸå®Œå…¨ã«ç‹¬ç«‹ã—ãŸE2Eãƒ†ã‚¹ãƒˆç’°å¢ƒã®æ§‹ç¯‰ã¨ä½¿ç”¨æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚ã“ã®ç’°å¢ƒã«ã‚ˆã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã¨CI/CDç’°å¢ƒã®ä¸¡æ–¹ã§ä¸€è²«ã—ãŸãƒ†ã‚¹ãƒˆçµæœã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## ğŸ¯ ä¸»ãªç‰¹å¾´

- **å®Œå…¨ãªç’°å¢ƒåˆ†é›¢**: ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã®ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ãªã„å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
- **CI/CDå¯¾å¿œ**: GitHub Actionsã§ãã®ã¾ã¾Shå¯èƒ½
- **é«˜é€Ÿãªãƒ“ãƒ«ãƒ‰**: ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
- **ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½**: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã€ãƒˆãƒ¬ãƒ¼ã‚¹ã€è©³ç´°ãƒ­ã‚°
- **æŸ”è»Ÿãªå®Ÿè¡Œ**: ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œã€ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ

## ğŸ“‹ å‰ææ¡ä»¶

- Docker 20.10ä»¥ä¸Š
- Docker Compose v2.0ä»¥ä¸Š
- 8GBä»¥ä¸Šã®ãƒ¡ãƒ¢ãƒªï¼ˆæ¨å¥¨ï¼‰

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### åŸºæœ¬çš„ãªä½¿ç”¨æ–¹æ³•

```bash
# 1. ã™ã¹ã¦ã®E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
make -f Makefile.docker test

# 2. ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œ
./scripts/docker-e2e-test.sh e2e/basic.spec.ts

# 3. ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
./scripts/docker-e2e-test.sh --grep "login"

# 4. ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œï¼ˆUIãƒ¢ãƒ¼ãƒ‰ï¼‰
make -f Makefile.docker test-watch

# 5. ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
make -f Makefile.docker debug
```

### ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
make -f Makefile.docker build

# ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ï¼ˆãƒ†ã‚¹ãƒˆã¯å®Ÿè¡Œã—ãªã„ï¼‰
make -f Makefile.docker start

# ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
make -f Makefile.docker status

# ãƒ­ã‚°ã‚’è¡¨ç¤º
make -f Makefile.docker logs
```

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### Docker Compose æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Docker Network (172.28.0.0/16)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ PostgreSQL   â”‚  â”‚ API Server   â”‚             â”‚
â”‚  â”‚ (postgres-   â”‚  â”‚ (api-test)   â”‚             â”‚
â”‚  â”‚  test)       â”‚â—„â”€â”¤ Port: 3001   â”‚             â”‚
â”‚  â”‚ Port: 5432   â”‚  â”‚              â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                            â–²                      â”‚
â”‚                            â”‚                      â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                     â”‚ Web Server   â”‚             â”‚
â”‚                     â”‚ (web-test)   â”‚             â”‚
â”‚                     â”‚ Port: 3000   â”‚             â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                            â–²                      â”‚
â”‚                            â”‚                      â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                     â”‚ Playwright   â”‚             â”‚
â”‚                     â”‚ Test Runner  â”‚             â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°

#### 1. PostgreSQL (postgres-test)

- **ã‚¤ãƒ¡ãƒ¼ã‚¸**: postgres:16-alpine
- **ç”¨é€”**: ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- **ç‰¹å¾´**: tmpfsã«ã‚ˆã‚‹é«˜é€ŸI/O

#### 2. API Server (api-test)

- **ãƒ“ãƒ«ãƒ‰**: apps/api/Dockerfile.test
- **ç”¨é€”**: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API
- **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯**: /api/v1/health

#### 3. Web Server (web-test)

- **ãƒ“ãƒ«ãƒ‰**: apps/web/Dockerfile.test
- **ç”¨é€”**: Next.jsãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯**: /

#### 4. Playwright Runner

- **ãƒ“ãƒ«ãƒ‰**: Dockerfile.playwright
- **ç”¨é€”**: E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- **ãƒ–ãƒ©ã‚¦ã‚¶**: Chromiumï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

## ğŸ”§ è¨­å®š

### ç’°å¢ƒå¤‰æ•°

```bash
# ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
DEBUG=true make -f Makefile.docker test

# ã‚³ãƒ³ãƒ†ãƒŠã‚’å®Ÿè¡Œå¾Œã‚‚ç¶­æŒ
KEEP_RUNNING=true make -f Makefile.docker test

# è¤‡æ•°ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ†ã‚¹ãƒˆ
BROWSERS="chromium firefox" make -f Makefile.docker test
```

### Docker Compose è¨­å®šã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

`docker-compose.test.yml` ã‚’ç·¨é›†ã—ã¦è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã™ï¼š

```yaml
# ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
services:
  web-test:
    ports:
      - '3010:3000' # ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤
```

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

#### 1. ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ãªã„

```bash
# ãƒ­ã‚°ã‚’ç¢ºèª
make -f Makefile.docker logs

# å€‹åˆ¥ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ã‚°ã‚’ç¢ºèª
make -f Makefile.docker logs-api-test
```

#### 2. ãƒ†ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹

```bash
# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ã‚’å¢—ã‚„ã™
TEST_TIMEOUT=120000 make -f Makefile.docker test
```

#### 3. ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼

```bash
# Docker ã®ãƒ¡ãƒ¢ãƒªåˆ¶é™ã‚’ç¢ºèª
docker system info | grep Memory

# ä¸è¦ãªã‚³ãƒ³ãƒ†ãƒŠã¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤
docker system prune -a
```

#### 4. ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å•é¡Œ

```bash
# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ã§ãƒªãƒ“ãƒ«ãƒ‰
make -f Makefile.docker rebuild
```

### ãƒ‡ãƒãƒƒã‚°æ–¹æ³•

```bash
# 1. Playwright ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã‚·ã‚§ãƒ«ã‚’é–‹ã
make -f Makefile.docker shell

# 2. ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒ†ã‚¹ãƒˆã‚’æ‰‹å‹•å®Ÿè¡Œ
cd /app/apps/web
npx playwright test --debug

# 3. ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ç¢ºèª
ls -la artifacts/
```

## ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ

### ãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª

ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾Œã€ä»¥ä¸‹ã®å ´æ‰€ã«çµæœãŒä¿å­˜ã•ã‚Œã¾ã™ï¼š

- **HTML ãƒ¬ãƒãƒ¼ãƒˆ**: `playwright-report/index.html`
- **JUnit XML**: `test-results/results.xml`
- **ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ**: `artifacts/`
- **ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«**: `test-results/`

```bash
# HTML ãƒ¬ãƒãƒ¼ãƒˆã‚’é–‹ã
open playwright-report/index.html

# ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’é–‹ã
npx playwright show-trace test-results/trace.zip
```

## ğŸš€ CI/CD çµ±åˆ

### GitHub Actions

`.github/workflows/e2e-docker.yml` ãŒè‡ªå‹•çš„ã«ä»¥ä¸‹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œã•ã‚Œã¾ã™ï¼š

- main ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥
- Pull Request ã®ä½œæˆãƒ»æ›´æ–°
- æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ï¼ˆworkflow_dispatchï¼‰

### ãƒ­ãƒ¼ã‚«ãƒ«ã§CIã‚’å†ç¾

```bash
# CIç’°å¢ƒã¨åŒã˜è¨­å®šã§ãƒ†ã‚¹ãƒˆ
CI=true make -f Makefile.docker test
```

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ãƒ“ãƒ«ãƒ‰æ™‚é–“ã®çŸ­ç¸®

1. **ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã®æ´»ç”¨**

   ```dockerfile
   FROM base AS deps
   FROM deps AS build
   FROM base AS runtime
   ```

2. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¦ãƒ³ãƒˆã®ä½¿ç”¨**

   ```dockerfile
   RUN --mount=type=cache,target=/root/.pnpm-store \
       pnpm install --frozen-lockfile
   ```

3. **ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰**
   ```bash
   docker compose -f docker-compose.test.yml build --parallel
   ```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã®çŸ­ç¸®

1. **ä¸¦åˆ—å®Ÿè¡Œ**

   ```bash
   TEST_WORKERS=4 make -f Makefile.docker test
   ```

2. **ç‰¹å®šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã¿å®Ÿè¡Œ**
   ```bash
   ./scripts/docker-e2e-test.sh --project=chromium-desktop
   ```

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

- ãƒ†ã‚¹ãƒˆç’°å¢ƒå°‚ç”¨ã®èªè¨¼æƒ…å ±ã‚’ä½¿ç”¨
- æœ¬ç•ªç’°å¢ƒã®æƒ…å ±ã¯çµ¶å¯¾ã«å«ã‚ãªã„
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯å®Œå…¨ã«åˆ†é›¢

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [E2Eãƒ†ã‚¹ãƒˆå®Ÿè£…ã‚¬ã‚¤ãƒ‰](./e2e-test-implementation.md)
- [Playwrightè¨­å®š](../apps/web/playwright.config.ts)
- [CI/CDè¨­å®š](.github/workflows/)

## ğŸ¤ è²¢çŒ®æ–¹æ³•

1. æ–°ã—ã„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®è¿½åŠ 
2. Dockerè¨­å®šã®æ”¹å–„ææ¡ˆ
3. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€GitHubã§Issueã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
