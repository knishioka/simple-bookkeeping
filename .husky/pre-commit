# Check for prohibited environment variables and bypass attempts
if [ -n "$SKIP" ] || [ -n "$PRE_COMMIT_ALLOW_NO_CONFIG" ] || [ -n "$HUSKY" ] && [ "$HUSKY" = "0" ]; then
  echo "âŒ ã‚¨ãƒ©ãƒ¼: pre-commitãƒã‚§ãƒƒã‚¯ã®å›žé¿ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"
  echo ""
  echo "æ¤œå‡ºã•ã‚ŒãŸç¦æ­¢ç’°å¢ƒå¤‰æ•°:"
  [ -n "$SKIP" ] && echo "  - SKIP=$SKIP"
  [ -n "$PRE_COMMIT_ALLOW_NO_CONFIG" ] && echo "  - PRE_COMMIT_ALLOW_NO_CONFIG=$PRE_COMMIT_ALLOW_NO_CONFIG"
  [ "$HUSKY" = "0" ] && echo "  - HUSKY=0"
  echo ""
  echo "ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’é€šéŽã•ã›ã¦ã‹ã‚‰ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„:"
  echo "  1. gitleaksã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡ºã‚’ã‚¯ãƒªã‚¢"
  echo "  2. ESLintã®è­¦å‘Šã‚’ã‚¼ãƒ­ã«"
  echo "  3. Prettierã®ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã‚’é©ç”¨"
  echo ""
  echo "âš ï¸  ä»¥ä¸‹ã®å›žé¿æ‰‹æ®µã‚‚ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™:"
  echo "  - git commit --no-verify"
  echo "  - git commit -n"
  echo "  - git -c core.hooksPath=/dev/null commit"
  echo ""
  echo "è©³ç´°ã¯ docs/ai-guide/security-deployment.md ã‚’å‚ç…§ã—ã¦ãã ã•ã„"
  exit 1
fi

# Create marker file to detect --no-verify usage
# This will be checked by prepare-commit-msg hook
touch .git/pre-commit-executed

# Check for secrets using gitleaks
if command -v gitleaks >/dev/null 2>&1; then
  echo "ðŸ” Checking for secrets with gitleaks..."
  gitleaks detect --source . --verbose --redact
  if [ $? -ne 0 ]; then
    echo "âŒ Secrets detected! Please remove them before committing."
    exit 1
  fi
  echo "âœ… No secrets detected"
else
  echo "âš ï¸  gitleaks is not installed. Install it with: brew install gitleaks"
fi

# Run build checks for dependency issues
if [ -f "./scripts/check-build.sh" ]; then
  bash ./scripts/check-build.sh
  if [ $? -ne 0 ]; then
    echo "âŒ Build checks failed! Please fix the issues before committing."
    exit 1
  fi
fi

# Check GitHub Actions workflows if they've been modified
workflow_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.github/workflows/.*\.(yml|yaml)$' || true)
script_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(sh|bash)$' || true)

if [ -n "$workflow_files" ] || [ -n "$script_files" ]; then
  if [ -f "./scripts/validate-workflows.sh" ]; then
    echo "ðŸ” Validating workflows and scripts..."

    # Determine what to validate
    validate_args=""
    if [ -n "$workflow_files" ]; then
      validate_args="-w"
    fi
    if [ -n "$script_files" ]; then
      if [ -z "$validate_args" ]; then
        validate_args="-s"
      else
        # Both workflows and scripts changed, validate all
        validate_args=""
      fi
    fi

    # Run validation but don't block if tools aren't installed
    bash ./scripts/validate-workflows.sh $validate_args || true
    echo "âš ï¸  Validation completed (non-blocking for initial implementation)"
  fi
fi

# Auto-fix missing newlines at end of files
echo "ðŸ”§ Auto-fixing missing newlines at end of files..."
files_fixed=""
for file in $(git diff --cached --name-only --diff-filter=ACM); do
  if [ -f "$file" ] && [ -s "$file" ]; then
    if [ -n "$(tail -c 1 "$file")" ]; then
      echo "" >> "$file"
      git add "$file"
      files_fixed="$files_fixed $file"
    fi
  fi
done

if [ -n "$files_fixed" ]; then
  echo "âœ… Fixed missing newlines in:"
  for file in $files_fixed; do
    echo "  - $file"
  done
else
  echo "âœ… All files have proper newlines"
fi

npx lint-staged
