# Check for secrets using gitleaks
if command -v gitleaks >/dev/null 2>&1; then
  echo "ðŸ” Checking for secrets with gitleaks..."
  gitleaks detect --source . --verbose --redact
  if [ $? -ne 0 ]; then
    echo "âŒ Secrets detected! Please remove them before committing."
    exit 1
  fi
  echo "âœ… No secrets detected"
else
  echo "âš ï¸  gitleaks is not installed. Install it with: brew install gitleaks"
fi

# Run build checks for dependency issues
if [ -f "./scripts/check-build.sh" ]; then
  bash ./scripts/check-build.sh
  if [ $? -ne 0 ]; then
    echo "âŒ Build checks failed! Please fix the issues before committing."
    exit 1
  fi
fi

# Auto-fix missing newlines at end of files
echo "ðŸ”§ Auto-fixing missing newlines at end of files..."
files_fixed=""
for file in $(git diff --cached --name-only --diff-filter=ACM); do
  if [ -f "$file" ] && [ -s "$file" ]; then
    if [ -n "$(tail -c 1 "$file")" ]; then
      echo "" >> "$file"
      git add "$file"
      files_fixed="$files_fixed $file"
    fi
  fi
done

if [ -n "$files_fixed" ]; then
  echo "âœ… Fixed missing newlines in:"
  for file in $files_fixed; do
    echo "  - $file"
  done
else
  echo "âœ… All files have proper newlines"
fi

npx lint-staged
