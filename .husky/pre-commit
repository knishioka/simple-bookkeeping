# Check for secrets using gitleaks
if command -v gitleaks >/dev/null 2>&1; then
  echo "🔍 Checking for secrets with gitleaks..."
  gitleaks detect --source . --verbose --redact
  if [ $? -ne 0 ]; then
    echo "❌ Secrets detected! Please remove them before committing."
    exit 1
  fi
  echo "✅ No secrets detected"
else
  echo "⚠️  gitleaks is not installed. Install it with: brew install gitleaks"
fi

# Run build checks for dependency issues
if [ -f "./scripts/check-build.sh" ]; then
  bash ./scripts/check-build.sh
  if [ $? -ne 0 ]; then
    echo "❌ Build checks failed! Please fix the issues before committing."
    exit 1
  fi
fi

# Check for missing newlines at end of files
echo "🔍 Checking for missing newlines at end of files..."
files_without_newline=""
for file in $(git diff --cached --name-only --diff-filter=ACM); do
  if [ -f "$file" ] && [ -s "$file" ]; then
    if [ -n "$(tail -c 1 "$file")" ]; then
      files_without_newline="$files_without_newline $file"
    fi
  fi
done

if [ -n "$files_without_newline" ]; then
  echo "❌ Files missing newline at end:"
  for file in $files_without_newline; do
    echo "  - $file"
  done
  echo "💡 Fix by adding a newline at the end of each file"
  exit 1
fi
echo "✅ All files have proper newlines"

npx lint-staged
