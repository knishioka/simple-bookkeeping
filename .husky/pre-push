echo "ğŸš€ Running pre-push checks..."

# Check if we're pushing to main or production branches
BRANCH=$(git rev-parse --abbrev-ref HEAD)
PROTECTED_BRANCHES="main master production"

if echo "$PROTECTED_BRANCHES" | grep -w "$BRANCH" > /dev/null; then
  echo "ğŸ“‹ Pushing to protected branch '$BRANCH', running full build checks..."
  
  # Run security audit for dependencies
  echo "ğŸ”’ Checking for security vulnerabilities..."
  pnpm audit --audit-level=high
  AUDIT_EXIT_CODE=$?
  
  if [ $AUDIT_EXIT_CODE -eq 1 ]; then
    echo "âš ï¸  Security vulnerabilities found (high or critical severity)"
    echo "ğŸ’¡ Run 'pnpm audit' for details or 'pnpm audit fix' to attempt automatic fixes"
    echo "âš ï¸  Proceeding with push, but please address vulnerabilities soon"
    # Note: We're not exiting here to avoid blocking deployments,
    # but you can change this to 'exit 1' for stricter enforcement
  elif [ $AUDIT_EXIT_CODE -gt 1 ]; then
    echo "âŒ Error running security audit"
    exit 1
  else
    echo "âœ… No high or critical vulnerabilities found"
  fi
  
  # Run Vercel build check
  echo "ğŸ”¨ Checking Vercel build (Web app)..."
  if ! NODE_ENV=production pnpm --filter @simple-bookkeeping/web build; then
    echo "âŒ Vercel build failed! Please fix build errors before pushing."
    echo "ğŸ’¡ Run 'NODE_ENV=production pnpm --filter @simple-bookkeeping/web build' to see detailed errors"
    exit 1
  fi
  echo "âœ… Vercel build passed"
  
  # Run Render build check (API server)
  echo "ğŸ”¨ Checking Render build (API server)..."
  if ! pnpm --filter @simple-bookkeeping/api build; then
    echo "âŒ Render build failed! Please fix build errors before pushing."
    echo "ğŸ’¡ Run 'pnpm --filter @simple-bookkeeping/api build' to see detailed errors"
    exit 1
  fi
  echo "âœ… Render build passed"
  
  echo "âœ… All pre-push checks passed!"
else
  echo "ğŸ“ Pushing to feature branch '$BRANCH', skipping full build checks"
fi