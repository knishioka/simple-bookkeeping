#!/bin/bash

# ============================================================================
# migrate-render-db.sh - Render Database Migration Script
# ============================================================================
# Purpose: Execute Prisma database migrations on Render's PostgreSQL database
# Usage: DATABASE_URL='postgresql://user:pass@host:port/db' ./scripts/migrate-render-db.sh
# Requirements: Node.js, Prisma CLI, Render database connection string
# Note: Interactive script that prompts for seeding data after migration
# ============================================================================

set -e

echo "ğŸ”„ Renderãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™..."

# ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
if [ -z "$DATABASE_URL" ]; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: DATABASE_URL ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
    echo "ä½¿ç”¨æ–¹æ³•: DATABASE_URL='postgresql://...' ./scripts/migrate-render-db.sh"
    exit 1
fi

# Prismaãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd packages/database

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
echo "ğŸ“¦ Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç”Ÿæˆä¸­..."
npx prisma generate

echo "ğŸš€ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œä¸­..."
npx prisma migrate deploy

echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸï¼"

# ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
read -p "ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¾ã™ã‹ï¼Ÿ (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "ğŸŒ± ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ä¸­..."
    npx prisma db seed
    echo "âœ… ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
fi