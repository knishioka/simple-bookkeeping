name: Security Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  gitleaks:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks with Custom Config
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml
          GITLEAKS_ENABLE_COMMENTS: false

  lint-strict:
    name: Lint Check (Zero Warnings)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter @simple-bookkeeping/database prisma:generate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/simple_bookkeeping_test?schema=public

      - name: Build packages
        run: pnpm build:packages
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-key' }}

      - name: Run ESLint with zero warnings
        run: pnpm lint:strict
        env:
          CI: true

  commit-message-check:
    name: Commit Message Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for prohibited patterns
        run: |
          echo "ğŸ” Checking commit messages for prohibited patterns..."

          # Get all commit messages in this PR
          commits=$(git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%H %s")

          # Check for SKIP, PRE_COMMIT, HUSKY patterns
          if echo "$commits" | grep -iE "(SKIP=|PRE_COMMIT_ALLOW_NO_CONFIG|HUSKY=0)"; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ç¦æ­¢ã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo ""
            echo "ä»¥ä¸‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ä½¿ç”¨ç¦æ­¢ã§ã™:"
            echo "  - SKIP=*"
            echo "  - PRE_COMMIT_ALLOW_NO_CONFIG=*"
            echo "  - HUSKY=0"
            echo ""
            echo "ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’æ­£è¦ã®æ–¹æ³•ã§é€šéã•ã›ã¦ãã ã•ã„"
            exit 1
          fi

          # Check for --no-verify usage indicators
          if echo "$commits" | grep -iE "(--no-verify|-n[[:space:]]|Pre-commit hooks were bypassed)"; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: pre-commitãƒ•ãƒƒã‚¯å›é¿ã®ç—•è·¡ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo ""
            echo "ä»¥ä¸‹ã®ä½¿ç”¨ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™:"
            echo "  - git commit --no-verify"
            echo "  - git commit -n"
            echo ""
            echo "ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’æ­£è¦ã®æ–¹æ³•ã§é€šéã•ã›ã¦ãã ã•ã„"
            exit 1
          fi

          echo "âœ… ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"

  security-summary:
    name: Security Check Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, lint-strict, commit-message-check]
    if: always()
    steps:
      - name: Security Check Status
        run: |
          echo "ğŸ” Security Check Summary"
          echo "========================"

          if [ "${{ needs.gitleaks.result }}" = "failure" ]; then
            echo "âŒ Secret Detection: Failed"
            echo "   æ©Ÿå¯†æƒ…å ±ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚"
          else
            echo "âœ… Secret Detection: Passed"
          fi

          if [ "${{ needs.lint-strict.result }}" = "failure" ]; then
            echo "âŒ Lint Check: Failed"
            echo "   ESLintã®è­¦å‘Šãƒ»ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚"
          else
            echo "âœ… Lint Check: Passed"
          fi

          if [ "${{ needs.commit-message-check.result }}" = "failure" ]; then
            echo "âŒ Commit Message: Failed"
            echo "   ç¦æ­¢ã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚"
          else
            echo "âœ… Commit Message: Passed"
          fi

          # Exit with failure if any check failed
          if [ "${{ needs.gitleaks.result }}" = "failure" ] || \
             [ "${{ needs.lint-strict.result }}" = "failure" ] || \
             [ "${{ needs.commit-message-check.result }}" = "failure" ]; then
            echo ""
            echo "âš ï¸  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "è©³ç´°ã¯ä¸Šè¨˜ã®å„ã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            exit 1
          fi

          echo ""
          echo "ğŸ‰ ã™ã¹ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸ"
