name: Production Smoke Tests

on:
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:

  # Vercelãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾Œã«è‡ªå‹•å®Ÿè¡Œï¼ˆå°†æ¥å®Ÿè£…ï¼‰
  # deployment:
  #   types: [created]

  # å®šæœŸå®Ÿè¡Œï¼ˆ1æ—¥1å›ã€æ—¥æœ¬æ™‚é–“åˆå‰10æ™‚ï¼‰
  schedule:
    - cron: '0 1 * * *' # UTC 1:00 = JST 10:00

  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸å¾Œ
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.vscode/**'

env:
  # Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³
  NODE_VERSION: '20'

  # Productionç’°å¢ƒè¨­å®š
  PROD_URL: https://simple-bookkeeping-mu.vercel.app

  # å®Ÿè¡Œå›æ•°åˆ¶é™
  MAX_DAILY_RUNS: 3

jobs:
  smoke-test:
    name: Run Production Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # æœ¬ç•ªç’°å¢ƒã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ˜ç¤º
    environment:
      name: production
      url: ${{ env.PROD_URL }}

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“š Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ­ Install Playwright Browsers
        run: pnpm exec playwright install chromium --with-deps

      - name: ğŸ§ª Run Smoke Tests
        env:
          # Productionç’°å¢ƒã®èªè¨¼æƒ…å ±ï¼ˆGitHub Secretsã‹ã‚‰ï¼‰
          PROD_TEST_EMAIL: ${{ secrets.PROD_TEST_EMAIL }}
          PROD_TEST_PASSWORD: ${{ secrets.PROD_TEST_PASSWORD }}
          PROD_URL: ${{ env.PROD_URL }}
          # E2Eãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰
          TEST_MODE: prod
        run: |
          cd apps/web
          pnpm test:e2e:prod:smoke

      - name: ğŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-smoke
          path: apps/web/playwright-report/
          retention-days: 7

      - name: ğŸ” Upload Test Traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-smoke
          path: apps/web/test-results/
          retention-days: 7

      # Slackãªã©ã¸ã®é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: ğŸ“¢ Notify on Failure
        if: failure()
        run: |
          echo "âš ï¸ Production smoke tests failed!"
          echo "Check the test results and traces for details."
          # TODO: Slack webhook or other notification service integration

      - name: âœ… Success Message
        if: success()
        run: |
          echo "âœ… Production smoke tests passed successfully!"
          echo "All critical user paths are functioning correctly."

  # å®Ÿè¡Œå›æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
  check-limits:
    name: Check Execution Limits
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: ğŸ”’ Check Daily Execution Limit
        run: |
          echo "Checking daily execution limits..."
          # TODO: Implement execution limit tracking
          # - Use GitHub API to check workflow runs
          # - Count today's executions
          # - Skip if limit exceeded
